const { Telegraf, InputFile } = require('telegraf');
const { exec } = require('child_process');
const { promisify } = require('util');
const fs = require('fs');
const os = require('os');
const path = require('path');

const execAsync = promisify(exec);
const bot = new Telegraf(process.env.BOT_TOKEN);

// ============ –ù–ê–°–¢–†–û–ô–ö–ò ============
const TEMP_DIR = os.tmpdir();
const COOLDOWN_SECONDS = 30;
const userCooldown = new Map();
let isDownloading = false;

// ============ –î–ï–†–ñ–ò–ú REPLIT –û–ù–õ–ê–ô–ù ============
const http = require('http');
const server = http.createServer((req, res) => {
  res.writeHead(200, { 'Content-Type': 'text/plain' });
  res.end('ü§ñ Media Download Bot —Ä–∞–±–æ—Ç–∞–µ—Ç!');
});
server.listen(3000);

// ============ –ö–û–ú–ê–ù–î–´ –ë–û–¢–ê ============
bot.command('start', (ctx) => {
  ctx.reply(`üé¨ Media Download Bot

üì¶ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:
üéµ –Ø–Ω–¥–µ–∫—Å.–ú—É–∑—ã–∫–∞ (—Ç—Ä–µ–∫–∏, –∞–ª—å–±–æ–º—ã)
üé¨ YouTube (–≤–∏–¥–µ–æ, shorts)
üì± TikTok (–≤—Å–µ –≤–∏–¥–µ–æ)
üì∏ Instagram (reels, posts)

‚ö° –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø:
‚Ä¢ –í–∏–¥–µ–æ ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–∞–∫ —Ñ–∞–π–ª (–¥–æ 2GB)
‚Ä¢ –ê—É–¥–∏–æ ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–∞–∫ –º—É–∑—ã–∫—É (–¥–æ 50MB)

üéØ –ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É!

‚è± –õ–∏–º–∏—Ç: 1 –∑–∞–ø—Ä–æ—Å –≤ ${COOLDOWN_SECONDS} —Å–µ–∫—É–Ω–¥

–ö–æ–º–∞–Ω–¥—ã:
/start - —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
/help - –ø–æ–º–æ—â—å
/test - —Ç–µ—Å—Ç–æ–≤—ã–µ —Å—Å—ã–ª–∫–∏
/status - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã`);
});

bot.command('help', (ctx) => {
  ctx.reply(`üìñ –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:

1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞:
   ‚Ä¢ –Ø–Ω–¥–µ–∫—Å.–ú—É–∑—ã–∫–∞: music.yandex.ru/album/.../track/...
   ‚Ä¢ YouTube: youtube.com/watch?v=... –∏–ª–∏ youtu.be/...
   ‚Ä¢ TikTok: tiktok.com/@user/video/...
   ‚Ä¢ Instagram: instagram.com/reel/...

2. –ñ–¥–∏—Ç–µ 1-5 –º–∏–Ω—É—Ç
3. –ü–æ–ª—É—á–∏—Ç–µ —Ñ–∞–π–ª –≤ Telegram
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ

‚ö†Ô∏è –î–ª—è –Ø–Ω–¥–µ–∫—Å.–ú—É–∑—ã–∫–∏ –∏–Ω–æ–≥–¥–∞ –Ω—É–∂–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è`);
});

bot.command('test', (ctx) => {
  ctx.reply(`üß™ –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Å—ã–ª–∫–∏:

üéµ –Ø–Ω–¥–µ–∫—Å.–ú—É–∑—ã–∫–∞:
https://music.yandex.ru/album/6478262/track/57446829

üé¨ YouTube:
https://youtu.be/dQw4w9WgXcQ

üì± TikTok (–ø—Ä–∏–º–µ—Ä):
https://www.tiktok.com/@willsmith/video/7078969024029322538

üì∏ Instagram:
https://www.instagram.com/reel/Cxc8GC6Npcm/`);
});

bot.command('status', async (ctx) => {
  try {
    const { stdout } = await execAsync('yt-dlp --version');
    ctx.reply(`‚úÖ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç\nüì¶ yt-dlp: ${stdout.trim()}\nüë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${userCooldown.size}`);
  } catch {
    ctx.reply('‚ö†Ô∏è yt-dlp –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
  }
});

// ============ –û–°–ù–û–í–ù–û–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö ============
bot.on('text', async (ctx) => {
  if (ctx.message.text.startsWith('/')) return;
  
  const userId = ctx.from.id;
  const text = ctx.message.text;
  const chatId = ctx.chat.id;
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—É–ª–¥–∞—É–Ω–∞
  const now = Math.floor(Date.now() / 1000);
  const lastRequest = userCooldown.get(userId);
  
  if (lastRequest && (now - lastRequest) < COOLDOWN_SECONDS) {
    const waitTime = COOLDOWN_SECONDS - (now - lastRequest);
    await ctx.reply(`‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ ${waitTime} —Å–µ–∫—É–Ω–¥`);
    return;
  }
  
  if (isDownloading) {
    await ctx.reply('üì• –£–∂–µ —Å–∫–∞—á–∏–≤–∞—é. –ü–æ–¥–æ–∂–¥–∏—Ç–µ...');
    return;
  }
  
  userCooldown.set(userId, now);
  
  // –ò—â–µ–º URL
  const urlRegex = /(https?:\/\/[^\s]+)/g;
  const urls = text.match(urlRegex);
  
  if (!urls) {
    await ctx.reply('‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ —Å—Å—ã–ª–æ–∫');
    return;
  }
  
  const url = urls[0];
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—É
  const platform = detectPlatform(url);
  if (!platform) {
    await ctx.reply('‚ùå –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é —Ç–æ–ª—å–∫–æ: –Ø–Ω–¥–µ–∫—Å.–ú—É–∑—ã–∫–∞, YouTube, TikTok, Instagram');
    return;
  }
  
  isDownloading = true;
  const statusMsg = await ctx.reply(`üîç –û–ø—Ä–µ–¥–µ–ª—è—é ${platform}...`);
  
  try {
    // –®–∞–≥ 1: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    await ctx.telegram.editMessageText(
      chatId, statusMsg.message_id, null,
      'üìä –ü–æ–ª—É—á–∞—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é...'
    );
    
    // –®–∞–≥ 2: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ
    await ctx.telegram.editMessageText(
      chatId, statusMsg.message_id, null,
      '‚è¨ –°–∫–∞—á–∏–≤–∞—é...'
    );
    
    const result = await downloadMedia(url, platform);
    
    if (!result.success) {
      throw new Error(result.error);
    }
    
    // –®–∞–≥ 3: –û—Ç–ø—Ä–∞–≤–∫–∞
    const stats = fs.statSync(result.filepath);
    const fileSizeMB = stats.size / (1024 * 1024);
    
    await ctx.telegram.editMessageText(
      chatId, statusMsg.message_id, null,
      `‚úÖ ${fileSizeMB.toFixed(1)}MB\nüöÄ –û—Ç–ø—Ä–∞–≤–ª—è—é...`
    );
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
    const isAudio = platform === 'yandexmusic' || result.filepath.endsWith('.mp3');
    
    if (isAudio) {
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ –∞—É–¥–∏–æ
      await ctx.replyWithAudio(
        new InputFile(result.filepath),
        {
          caption: `üéµ ${result.title || '–¢—Ä–µ–∫'}\nüì¶ ${fileSizeMB.toFixed(1)}MB\nüîó ${url}`,
          reply_to_message_id: ctx.message.message_id
        }
      );
    } else {
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç (–¥–æ 2GB!)
      await ctx.replyWithDocument(
        new InputFile(result.filepath),
        {
          caption: `üé¨ ${result.title || '–í–∏–¥–µ–æ'}\nüì¶ ${fileSizeMB.toFixed(1)}MB\nüîó ${url}`,
          reply_to_message_id: ctx.message.message_id
        }
      );
    }
    
    // –û—á–∏—Å—Ç–∫–∞
    await ctx.telegram.deleteMessage(chatId, statusMsg.message_id);
    fs.unlinkSync(result.filepath);
    
    await ctx.reply('‚úÖ –ì–æ—Ç–æ–≤–æ! –§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤—ã—à–µ üëÜ');
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞:', error);
    await ctx.telegram.editMessageText(
      chatId, statusMsg.message_id, null,
      `‚ùå –û—à–∏–±–∫–∞: ${error.message}`
    );
  } finally {
    isDownloading = false;
  }
});

// ============ –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ============
function detectPlatform(url) {
  if (url.includes('music.yandex.ru') || url.includes('music.yandex.com')) return 'yandexmusic';
  if (url.includes('youtube.com') || url.includes('youtu.be')) return 'youtube';
  if (url.includes('tiktok.com')) return 'tiktok';
  if (url.includes('instagram.com')) return 'instagram';
  return null;
}

async function downloadMedia(url, platform) {
  const timestamp = Date.now();
  const ext = platform === 'yandexmusic' ? 'mp3' : 'mp4';
  const filepath = path.join(TEMP_DIR, `${platform}_${timestamp}.${ext}`);
  
  try {
    let command;
    
    if (platform === 'yandexmusic') {
      command = `yt-dlp --extract-audio --audio-format mp3 --audio-quality 320K -o "${filepath}" "${url}"`;
    } else if (platform === 'youtube') {
      command = `yt-dlp -f "best[height<=1080]" -o "${filepath}" "${url}"`;
    } else {
      command = `yt-dlp -f "best" -o "${filepath}" "${url}"`;
    }
    
    console.log('–ó–∞–ø—É—Å–∫–∞—é:', command);
    await execAsync(command, { timeout: 300000 });
    
    // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ
    const { stdout: info } = await execAsync(
      `yt-dlp --get-title --no-warnings "${url}"`
    );
    
    return {
      success: true,
      filepath: filepath,
      title: info.trim() || '–§–∞–π–ª'
    };
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è:', error);
    
    if (fs.existsSync(filepath)) {
      fs.unlinkSync(filepath);
    }
    
    return {
      success: false,
      error: error.message.includes('Private') ? '–ö–æ–Ω—Ç–µ–Ω—Ç –ø—Ä–∏–≤–∞—Ç–Ω—ã–π' :
             error.message.includes('Not found') ? '–ù–µ –Ω–∞–π–¥–µ–Ω–æ' :
             '–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è'
    };
  }
}

// ============ –ó–ê–ü–£–°–ö ============
bot.launch()
  .then(() => {
    console.log('‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω! –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ø–Ω–¥–µ–∫—Å.–ú—É–∑—ã–∫—É, YouTube, TikTok, Instagram');
  })
  .catch((err) => {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞:', err);
  });

process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));